<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Odd Api Design: loadOptions prop in async React Select</title><link rel=stylesheet href=/blog/css/style.css></head><body><header><div class=header-title-wrapper><div class=header-title><a class=header-link href=https://sacredsatan.com/blog>sacredSatan/blog</a><div class=header-subtitle>slash blog... slAsH bLOg... SLASH BLOG.</div></div><nav><a href=/blog/posts/><b>Posts</b></a>.
<a href=/blog/tags/><b>Tags</b></a>.
<a href=/blog/categories/><b>Categories</b></a>.</nav></div></header><main><article><h1>Odd Api Design: loadOptions prop in async React Select</h1><b><time>16.10.2022 22:48</time></b>
<a href=/tags/javascript>javascript</a>
<a href=/tags/api-design>api-design</a>
<a href=/tags/react-select>react-select</a>
<a href=/tags/bugs>bugs</a><div><p><code>react-select/async</code> has a <code>loadOptions</code> prop that helps you filter and display options based on some input string. The function you pass to <code>loadOptions</code> has two ways to set the options to display. This is what caused an unexpected (to me) issue. This isn&rsquo;t a sneaky bug since I caught the issue while developing.</p><p><code>react-select/async</code> passes two args to the function you pass in <code>loadOptions</code>, first arg is the filter string, and second arg is a callback function. Your function can either pass the options to the callback function, or return a promise that resolves to the options that need to be displayed.</p><p>I had to use the callback function way since <code>react-select/async</code> doesn&rsquo;t play well with debounced promises being returned from <code>loadOptions</code>, and the general advice on filed issues on Github was to use callback to set options instead. I didn&rsquo;t want to spend time going into why callbacks worked vs promises didn&rsquo;t.</p><p>Here&rsquo;s what my code sort of looked like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loadOptions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>inputValue</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>displayOptions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>asyncCallForOptions</span>(<span style=color:#a6e22e>inputValue</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>displayOptions</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (&lt;<span style=color:#f92672>AsyncSelect</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>loadOptions</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>loadOptions</span>}
</span></span><span style=display:flex><span>  /&gt;);
</span></span></code></pre></div><p>This caused an issue where <code>AsyncSelect</code> would render options at first but it&rsquo;d change to an empty dropdown almost immediately after.</p><p>What I didn&rsquo;t realize was I&rsquo;m still passing a function that returns a promise to <code>loadOptions</code>, which will resolve to <code>undefined</code>. This eventually led me to the source code which cleared things up.</p><p>Here&rsquo;s what the code to handle <code>loadOptions</code> in <code>react-select/async</code> looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// https://github.com/JedWatson/react-select/blob/master/packages/react-select/src/useAsync.ts#L112
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loadOptions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inputValue</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>callback</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>options</span><span style=color:#f92672>?:</span> <span style=color:#a6e22e>OptionsOrGroups</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Option</span>, <span style=color:#a6e22e>Group</span><span style=color:#f92672>&gt;</span>) =&gt; <span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>    ) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// propsLoadOptions is the `loadOptions` passed as a prop
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>propsLoadOptions</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>callback</span>(); 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>propsLoadOptions</span>(<span style=color:#a6e22e>inputValue</span>, <span style=color:#a6e22e>callback</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>loader</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>loader</span>.<span style=color:#a6e22e>then</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;function&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>loader</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>callback</span>, () =&gt; <span style=color:#a6e22e>callback</span>());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>propsLoadOptions</span>]
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p>This led to the options being set by the <code>callback(displayOptions)</code> call, and then replaced by <code>undefined</code> as the async function&rsquo;s promise resolves.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// https://github.com/JedWatson/react-select/blob/master/packages/react-select/src/useAsync.ts#L118
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// causes the `callback(displayOptions)` call, `loader` now has a Promise that resolves to `undefined`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>propsLoadOptions</span>(<span style=color:#a6e22e>inputValue</span>, <span style=color:#a6e22e>callback</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// loader.then exists because `propsLoadOptions` is an async function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>loader</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>loader</span>.<span style=color:#a6e22e>then</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;function&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this sets the display options to `undefined`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>loader</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>callback</span>, () =&gt; <span style=color:#a6e22e>callback</span>());
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>I just changed my function so it wasn&rsquo;t an async function anymore. It was entirely my fault for not following the api.</p><p>I think having <code>loadOptions</code> only take functions that return/resolve to the options to be displayed, and having another <code>loadOptionsCallback</code> prop that strictly does the things the callback way, would make things a lot simpler.</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/blog/posts/2022-10-16-odd-api-design-debounced-loadoptions-react-select/>Odd Api Design: loadOptions prop in async React Select</a></li><li><a href=/blog/posts/2022-08-15-sneaky-bugs-string-startswith-indexof/>Sneaky bugs: startsWith and indexOf with empty string</a></li><li><a href=/blog/posts/2021-11-28-sneaky-bugs-lodash-trimstart-substring/>Sneaky bugs: using lodash/trimStart to trim off a leading substring</a></li><li><a href=/blog/posts/2021-11-22-testing/>Testing</a></li></ul></div></div></aside><footer><p>&copy; 2023.
<a href=https://sacredsatan.com/><b>/</b></a>.
<a href=https://sacredsatan.com/blog><b>/blog</b></a>.
<a href=https://github.com/sacredsatan><b>Github</b></a>.</p></footer></body></html>