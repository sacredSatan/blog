<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Sneaky Bugs: string substitution and string split</title>
<link rel=stylesheet href=/blog/css/style.css></head><body><header><div class=header-title-wrapper><div class=header-title><a class=header-link href=https://sacredsatan.com/blog/>sacredSatan/blog</a><div class=header-subtitle>slash blog... slAsH bLOg... SLASH BLOG.</div></div><nav><a href=/blog/posts/><b>Posts</b></a>.
<a href=/blog/tags/><b>Tags</b></a>.
<a href=/blog/categories/><b>Categories</b></a>.</nav></div></header><main><article><h1>Sneaky Bugs: string substitution and string split</h1><b><time>21.10.2023 16:13</time></b>
<a href=/blog/tags/javascript>javascript</a>
<a href=/blog/tags/bugs>bugs</a>
<a href=/blog/tags/string>string</a><div><p>This is more silly than sneaky, but it did get past me and made its way to production.</p><p>Here&rsquo;s the problem: there&rsquo;s a string full of HTML, but you want to strip away everything other than text and anchor links.</p><p>The code runs in browser, and here&rsquo;s how I went about solving it using DOMParser:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>REPLACEMENT_TEXT</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;___replacement_text&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parsedDoc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DOMParser</span>().<span style=color:#a6e22e>parseFromString</span>(<span style=color:#a6e22e>htmlStr</span>, <span style=color:#e6db74>&#34;text/html&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// get the list of all anchor tags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>links</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>parsedDoc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// collect info for anchor tags and replace their text with a common replacement term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>anchorTags</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>string</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>href</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> }<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>link</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>links</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>replacementKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>REPLACEMENT_TEXT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>index</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>anchorTags</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>replacementKey</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>innerText</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>href</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#34;href&#34;</span>) <span style=color:#f92672>??</span> <span style=color:#e6db74>&#34;#&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>innerText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>replacementKey</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// loop over the anchor tags, use the replacement key to find and insert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// the anchor tag in sanitizedStr.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>bodyText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parsedDocument</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>innerText</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>anchorTags</span>.<span style=color:#a6e22e>forEach</span>(({ <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>href</span> }, <span style=color:#a6e22e>index</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>replacementKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>REPLACEMENT_TEXT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>index</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> [ <span style=color:#a6e22e>beforeText</span>, <span style=color:#a6e22e>afterText</span> ] <span style=color:#f92672>=</span> <span style=color:#a6e22e>bodyText</span>.<span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>replacementKey</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>beforeText</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`&lt;a href=&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>href</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>text</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/a&gt;`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bodyText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>afterText</span>;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>bodyText</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>bodyText</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sanitizedStr</span>;
</span></span></code></pre></div><p>This seemed to work okay, but it threw a TypeError saying <code>bodyText</code> is <code>undefined</code> for larger html strings.</p><p>This is because I was appending index to the replacement text, and <code>bodyText.split("abc_1");</code> not only splits the text on <code>"abc_1"</code>, it also splits at <code>"abc_10"</code>, <code>"abc_11"</code> etc. I was running out of <code>bodyText</code> sooner than expected because of that.</p><p>The code only &ldquo;works&rdquo; if the input string has 10 or fewer links in it.</p><p>Fortunately I work with people smarter than me, and someone pointed out that I don&rsquo;t even need an index in the replacement text if I just use an array to store <code>anchorTags</code>.</p><p>Here&rsquo;s what the version that works as intended looked like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// collect info for anchor tags and replace their text with a common replacement term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>anchorTags</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>href</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> }[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>link</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>links</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>anchorTags</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>innerText</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>href</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#34;href&#34;</span>) <span style=color:#f92672>??</span> <span style=color:#e6db74>&#34;#&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>innerText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>REPLACEMENT_TEXT</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bodyText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parsedDocument</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>innerText</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>splits</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>bodyText</span>.<span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>REPLACEMENT_TEXT</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>counter</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>counter</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>splits</span>.<span style=color:#a6e22e>length</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>splits</span>[<span style=color:#a6e22e>counter</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>anchorTags</span>[<span style=color:#a6e22e>counter</span>]) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>href</span>, <span style=color:#a6e22e>text</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>anchorTags</span>[<span style=color:#a6e22e>counter</span>];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sanitizedStr</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`&lt;a href=&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>href</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>text</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/a&gt;`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>counter</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>This was kind of similar to the <code>trimStart</code> bug where I expected it to stop after the &ldquo;first match&rdquo;.</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/blog/posts/2024-12-31-sneaky-bugs-defaults-with-dynamodb-onetable/>Sneaky Bugs: using defaults in schema with dynamodb-onetable</a></li><li><a href=/blog/posts/2023-10-21-sneaky-bugs-string-substitution-and-string-split/>Sneaky Bugs: string substitution and string split</a></li><li><a href=/blog/posts/2023-10-21-diwali-cleaning-blog-post-ideas-dump/>Diwali Cleaning: blog post ideas dump</a></li><li><a href=/blog/posts/2023-01-01-odd-api-design-debounced-loadoptions-react-select/>Odd Api Design: loadOptions prop in async React Select</a></li><li><a href=/blog/posts/2022-08-15-sneaky-bugs-string-startswith-indexof/>Sneaky bugs: startsWith and indexOf with empty string</a></li></ul></div></div></aside><footer><p>&copy; 2024.
<a href=https://sacredsatan.com/><b>/</b></a>.
<a href=https://sacredsatan.com/blog><b>/blog</b></a>.
<a href=https://github.com/sacredsatan><b>Github</b></a>.</p></footer></body></html>