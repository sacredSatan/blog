<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Sneaky Bugs: using defaults in schema with dynamodb-onetable</title>
<link rel=stylesheet href=/blog/css/style.css></head><body><header><div class=header-title-wrapper><div class=header-title><a class=header-link href=https://sacredsatan.com/blog/>sacredSatan/blog</a><div class=header-subtitle>slash blog... slAsH bLOg... SLASH BLOG.</div></div><nav><a href=/blog/posts/><b>Posts</b></a>.
<a href=/blog/tags/><b>Tags</b></a>.
<a href=/blog/categories/><b>Categories</b></a>.</nav></div></header><main><article><h1>Sneaky Bugs: using defaults in schema with dynamodb-onetable</h1><b><time>31.12.2024 19:09</time></b>
<a href=/blog/tags/bugs>bugs</a>
<a href=/blog/tags/dynamodb>dynamodb</a>
<a href=/blog/tags/aws>aws</a>
<a href=/blog/tags/dynamodb-onetable>dynamodb-onetable</a><div><p><a href=https://doc.onetable.io><code>dynamodb-onetable</code></a> is basically mongoose but for dynamodb. It allows you to model data, and takes care of validation etc. based on your schema. It also does a bunch of other things, including simplification of dynamodb requests, as they can get a bit complex.</p><p>The schema def allows you to define fields with their types and an optional default value, with a behaviour that I didn&rsquo;t expect, and caused a bug to sneak in.</p><p>I was not going to write about it since it didn&rsquo;t happen to me, but I wanted to get one post in for 2024, and I&rsquo;m out of ideas and time.</p><p>The schema def looks something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0.0.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>indexes</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>primary</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>hash</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;pk&#34;</span>, <span style=color:#a6e22e>sort</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;sk&#34;</span> },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>models</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TestModel</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> String, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;${_type}&#34;</span> },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withoutDefault</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> Boolean },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withDefault</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> Boolean, <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The model <code>TestModel</code> has two fields other than the primary keys. In the current state, the pk/sk fields will always equal to <code>test/TestModel</code>, which would be an issue if you were trying to write multiple records, but not in this case.</p><p>The usecase involved upserting records, and <code>dynamodb-onetable</code> updates fields with default values if they&rsquo;re missing from the <code>upsert</code> call args. This was a bit unexpected as you&rsquo;d only expect the <code>default</code> value to come into play when the field is previously unset.</p><h3 id=create>create</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// without args, only populates the default field
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>TestModel</span>.<span style=color:#a6e22e>create</span>({});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// expected and actual is same
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: false,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// with both fields, so populates them both
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>TestModel</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>withDefault</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>withoutDefault</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// expected and actual is same
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withoutDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span></code></pre></div><p>All good so far.</p><h3 id=upsert-vs-update>upsert vs update</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  <span style=color:#75715e>// current item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withoutDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// update works as expected
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>TestModel</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...pk/sk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>withoutDefault</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// expected and actual is same
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withoutDefault: false,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// upsert replaces all the missing fields with their default values if it exists
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>TestModel</span>.<span style=color:#a6e22e>upsert</span>({
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...pk/sk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>withoutDefault</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// expected
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withoutDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// actual
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withoutDefault: false, // replaced this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//   withDefault: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span></span></span></code></pre></div><p>Since the record got upserted multiple times with different set of args, not always containing the field with default, the actual value got replaced with the default value.</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/blog/posts/2024-12-31-sneaky-bugs-defaults-with-dynamodb-onetable/>Sneaky Bugs: using defaults in schema with dynamodb-onetable</a></li><li><a href=/blog/posts/2023-10-21-sneaky-bugs-string-substitution-and-string-split/>Sneaky Bugs: string substitution and string split</a></li><li><a href=/blog/posts/2023-10-21-diwali-cleaning-blog-post-ideas-dump/>Diwali Cleaning: blog post ideas dump</a></li><li><a href=/blog/posts/2023-01-01-odd-api-design-debounced-loadoptions-react-select/>Odd Api Design: loadOptions prop in async React Select</a></li><li><a href=/blog/posts/2022-08-15-sneaky-bugs-string-startswith-indexof/>Sneaky bugs: startsWith and indexOf with empty string</a></li></ul></div></div></aside><footer><p>&copy; 2024.
<a href=https://sacredsatan.com/><b>/</b></a>.
<a href=https://sacredsatan.com/blog><b>/blog</b></a>.
<a href=https://github.com/sacredsatan><b>Github</b></a>.</p></footer></body></html>